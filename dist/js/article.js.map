{"version":3,"file":"article.js","names":["getProfile","API_BASE","toast","toastError","confirmToast","urlParams","URLSearchParams","window","location","search","articleId","get","titleEl","document","getElementById","contentEl","metaEl","galleryEl","likesCount","likedByMe","async","loadArticle","textContent","innerHTML","res","fetch","credentials","data","json","ok","Error","message","status","a","article","Array","isArray","likes","length","me","isOwner","role","String","_id","author","some","id","images","commentCount","authorLabel","email","username","title","content","replace","parts","push","createdAt","fmtDate","join","addEventListener","handleLikeToggle","handleDeleteArticle","renderGallery","err","loadComments","container","comments","map","c","isAuthor","isAdmin","canEdit","text","Date","toLocaleString","renderComments","list","iso","toLocaleDateString","year","month","day","safe","src","main","createElement","className","thumbs","s","i","e","img","target","closest","idx","Number","dataset","querySelector","querySelectorAll","forEach","t","classList","remove","add","appendChild","preventDefault","textarea","commentText","value","trim","focus","method","headers","body","JSON","stringify","msg","test","commentEl","contains","okText","cancelText","onConfirm","textEl","oldText","original","newText","updated","currentTarget","textWrap","originalHtml","editBtn","disabled","area","catch","likeBusy","btn","countEl","prevLiked","prevCount","Math","max","setAttribute","totalLikes","liked","setTimeout","r","referrer","startsWith","origin","URL","pathname","href","back","saved","sessionStorage","getItem","history","section","style","display"],"sources":["article.js"],"mappings":"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","ignoreList":[],"sourcesContent":["import { getProfile, API_BASE } from './api.js'\r\nimport { toast, toastError, confirmToast } from './toast.js'\r\n\r\nconst urlParams = new URLSearchParams(window.location.search)\r\nconst articleId = urlParams.get('id')\r\n\r\nconst titleEl = document.getElementById('article-title')\r\nconst contentEl = document.getElementById('article-content')\r\nconst metaEl = document.getElementById('article-meta')\r\nconst galleryEl = document.getElementById('article-gallery')\r\n\r\nlet likesCount = 0\r\nlet likedByMe = false\r\n\r\nasync function loadArticle() {\r\n  titleEl.textContent = 'Ładowanie…'\r\n  contentEl.innerHTML = ''\r\n  metaEl.textContent = ''\r\n  galleryEl.innerHTML = ''\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/articles/${articleId}`, {\r\n      credentials: 'include'\r\n    })\r\n    const data = await res.json()\r\n    if (!res.ok) throw new Error(data?.message || `Błąd ${res.status}`)\r\n    const a = data.article || data\r\n\r\n    likesCount = Array.isArray(a.likes) ? a.likes.length : (a.likesCount || 0)\r\n\r\n    let me = null\r\n    try { me = await getProfile() } catch {}\r\n    const isOwner = me && (me.role === 'admin' || String(me._id) === String(a.author?._id || a.author))\r\n    likedByMe = !!(me && Array.isArray(a.likes) && a.likes.some(id => String(id) === String(me._id)))\r\n\r\n    const images = Array.isArray(a.images) ? a.images : []\r\n    const commentCount = typeof a.commentCount === 'number' ? a.commentCount : (data.commentCount || 0)\r\n    const authorLabel = a.author?.email || a.author?.username || 'Autor'\r\n\r\n    titleEl.textContent = a.title || '(bez tytułu)'\r\n    contentEl.innerHTML = (a.content || '').replace(/\\n/g, '<br>')\r\n\r\n    const parts = []\r\n    if (authorLabel) parts.push(authorLabel)\r\n    if (a.createdAt) parts.push(fmtDate(a.createdAt))\r\n    parts.push(`👍 <span id=\"likes-count\">${likesCount}</span>`)\r\n    parts.push(`💬 ${commentCount}`)\r\n\r\n    metaEl.innerHTML = `\r\n    <div class=\"meta-left\">\r\n        ${parts.join(' • ')}\r\n    </div>\r\n    <div class=\"meta-right\">\r\n        ${(!isOwner && me) ? `\r\n        <button id=\"like-btn\"\r\n                class=\"btn btn--ghost btn--like\"\r\n                aria-pressed=\"${likedByMe ? 'true' : 'false'}\"\r\n                aria-label=\"${likedByMe ? 'Cofnij polubienie' : 'Polub artykuł'}\">\r\n            <span class=\"like-label\">${likedByMe ? 'Lubisz' : 'Lubię to'}</span>\r\n        </button>\r\n        ` : ''}\r\n        ${isOwner ? `\r\n        <a id=\"editArticleBtn\" class=\"btn btn--ghost\" href=\"/new-article.html?id=${a._id}\">\r\n            Edytuj artykuł\r\n        </a>\r\n        <button id=\"deleteArticleBtn\" class=\"btn btn--danger\">Usuń artykuł</button>\r\n        ` : ''}\r\n    </div>\r\n    `\r\n\r\n    if (me && !isOwner) {\r\n      document.getElementById('like-btn')?.addEventListener('click', handleLikeToggle)\r\n    }\r\n\r\n    if (isOwner) {\r\n      document.getElementById('deleteArticleBtn')?.addEventListener('click', handleDeleteArticle)\r\n    }\r\n\r\n    renderGallery(images)\r\n  } catch (err) {\r\n    titleEl.textContent = 'Błąd'\r\n    metaEl.textContent = ''\r\n    contentEl.innerHTML = `<p style=\"color:crimson\">${err.message || 'Nie udało się wczytać artykułu.'}</p>`\r\n    galleryEl.innerHTML = ''\r\n  }\r\n}\r\n\r\nasync function loadComments() {\r\n  const container = document.getElementById('comments-container')\r\n  if (!container) return\r\n\r\n  container.innerHTML = '<p>Ładowanie komentarzy…</p>'\r\n\r\n  try {\r\n    // pobierz listę\r\n    const res = await fetch(`${API_BASE}/api/comments/${articleId}`)\r\n    const comments = await res.json()\r\n\r\n    // kto jest zalogowany (żeby wiedzieć czy pokazywać Edytuj/Usuń)\r\n    let me = null\r\n    try { me = await getProfile() } catch {}\r\n\r\n    // render\r\n    if (!Array.isArray(comments) || comments.length === 0) {\r\n      container.innerHTML = '<p>Brak komentarzy.</p>'\r\n      return\r\n    }\r\n\r\n    container.innerHTML = comments.map(c => {\r\n      const isAuthor = me && String(me._id) === String(c.author?._id || c.author)\r\n      const isAdmin  = me && me.role === 'admin'\r\n      const canEdit  = !!(isAuthor || isAdmin)\r\n\r\n      return `\r\n        <div class=\"comment\" data-id=\"${c._id}\">\r\n          <p class=\"comment-text\">${c.text}</p>\r\n          <div class=\"comment-meta\">\r\n            <span>${c.author?.username || 'Anonim'}</span> •\r\n            <span>${new Date(c.createdAt).toLocaleString()}</span>\r\n            ${canEdit ? `\r\n              <button class=\"btn--sm btn-edit-comment\">Edytuj</button>\r\n              <button class=\"btn--sm btn--danger btn-delete-comment\">Usuń</button>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n      `\r\n    }).join('')\r\n  } catch (err) {\r\n    container.innerHTML = '<p style=\"color:crimson\">Błąd ładowania komentarzy</p>'\r\n    toastError('Błąd ładowania komentarzy')\r\n  }\r\n}\r\n\r\n// === Formularz komentarza ===\r\ndocument.getElementById(\"comment-form\").addEventListener(\"submit\", async (e) => {\r\n  e.preventDefault()\r\n\r\n  const textarea = document.getElementById(\"comment-text\")\r\n  const commentText = (textarea?.value || \"\").trim()\r\n\r\n  // Walidacja frontowa (krótka)\r\n  if (!commentText || commentText.length < 6) {\r\n    toastError(\"Komentarz musi mieć przynajmniej 6 znaków.\")\r\n    textarea?.focus()\r\n    return\r\n  }\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/comments/${articleId}`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      credentials: \"include\",\r\n      body: JSON.stringify({ text: commentText })\r\n    })\r\n\r\n    let data = {}\r\n    try { data = await res.json() } catch {}\r\n\r\n    if (!res.ok) {\r\n      const msg = data?.message || \"Błąd serwera\"\r\n      toastError(msg)\r\n\r\n      // Jeśli po sanitacji komentarz jest pusty lub backend zgłasza 400 – czyść i fokusuj\r\n      if (\r\n        res.status === 400 &&\r\n        /pusty po odfiltrowaniu|co najmniej 6 znaków|nie może być pusty/i.test(msg)\r\n      ) {\r\n        if (textarea) {\r\n          textarea.value = \"\"\r\n          textarea.focus()\r\n        }\r\n      }\r\n      return\r\n    }\r\n\r\n    // Sukces — czyść pole i odśwież listę\r\n    if (textarea) textarea.value = \"\"\r\n    await loadComments()\r\n  } catch (err) {\r\n    toastError(err?.message || \"Błąd połączenia z serwerem\")\r\n    textarea?.focus()\r\n  }\r\n})\r\n\r\nfunction renderComments(comments, me) {\r\n    const list = document.getElementById('comments-list')\r\n    if (!list) return\r\n\r\n    list.innerHTML = comments.map(c => {\r\n        const canEdit = me && (me._id === c.author._id || me.role === 'admin')\r\n        return `\r\n        <div class=\"comment\" data-id=\"${c._id}\">\r\n            <p class=\"comment-text\">${c.text}</p>\r\n            <div class=\"comment-meta\">\r\n                <span>${c.author.username}</span> • \r\n                <span>${new Date(c.createdAt).toLocaleString()}</span>\r\n                ${canEdit ? `\r\n                    <button class=\"btn--sm btn-edit-comment\">Edytuj</button>\r\n                    <button class=\"btn--sm btn--danger btn-delete-comment\">Usuń</button>\r\n                ` : ''}\r\n            </div>\r\n        </div>\r\n        `\r\n    }).join('')\r\n}\r\n\r\ndocument.getElementById('comments-list')?.addEventListener('click', async e => {\r\n    const commentEl = e.target.closest('.comment')\r\n    if (!commentEl) return\r\n    const id = commentEl.dataset.id\r\n\r\n    // Usuń komentarz\r\n    if (e.target.classList.contains('btn-delete-comment')) {\r\n        confirmToast({\r\n            message: 'Usunąć ten komentarz?',\r\n            okText: 'Usuń',\r\n            cancelText: 'Anuluj',\r\n            onConfirm: async () => {\r\n                try {\r\n                    const res = await fetch(`${API_BASE}/api/comments/${id}`, {\r\n                        method: 'DELETE',\r\n                        credentials: 'include'\r\n                    })\r\n                    if (!res.ok) throw new Error((await res.json())?.message || `Błąd ${res.status}`)\r\n                    commentEl.remove()\r\n                    toast('Komentarz usunięty.', 'success')\r\n                } catch (err) {\r\n                    toastError(err.message || 'Błąd usuwania komentarza.')\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    // Edytuj komentarz\r\n    if (e.target.classList.contains('btn-edit-comment')) {\r\n        const textEl = commentEl.querySelector('.comment-text')\r\n        const oldText = textEl.textContent\r\n        textEl.innerHTML = `<textarea class=\"edit-comment-text\">${oldText}</textarea>\r\n            <div class=\"edit-actions\">\r\n                <button class=\"btn--sm btn-save-comment\">Zapisz</button>\r\n                <button class=\"btn--sm btn-cancel-edit\">Anuluj</button>\r\n            </div>`\r\n    }\r\n\r\n    // Anuluj edycję\r\n    if (e.target.classList.contains('btn-cancel-edit')) {\r\n        const textEl = commentEl.querySelector('.comment-text')\r\n        const original = textEl.dataset.original || ''\r\n        textEl.textContent = original || textEl.textContent\r\n    }\r\n\r\n    // Zapisz edycję\r\n    if (e.target.classList.contains('btn-save-comment')) {\r\n        const newText = commentEl.querySelector('.edit-comment-text')?.value.trim()\r\n        if (!newText || newText.length < 6) {\r\n            toastError('Komentarz musi mieć co najmniej 6 znaków.')\r\n            return\r\n        }\r\n        try {\r\n            const res = await fetch(`${API_BASE}/api/comments/${id}`, {\r\n                method: 'PUT',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                credentials: 'include',\r\n                body: JSON.stringify({ text: newText })\r\n            })\r\n            if (!res.ok) throw new Error((await res.json())?.message || `Błąd ${res.status}`)\r\n            const updated = await res.json()\r\n            commentEl.querySelector('.comment-text').textContent = updated.text\r\n            toast('Komentarz zaktualizowany.', 'success')\r\n        } catch (err) {\r\n            toastError(err.message || 'Błąd zapisu komentarza.')\r\n        }\r\n    }\r\n})\r\n\r\ndocument.getElementById('comments-container')?.addEventListener('click', async (e) => {\r\n  const container = e.currentTarget\r\n  const commentEl = e.target.closest('.comment')\r\n  if (!commentEl) return\r\n  const id = commentEl.dataset.id\r\n\r\n  // ========== USUŃ ==========\r\n  if (e.target.closest('.btn-delete-comment')) {\r\n    const ok = await confirmToast({\r\n      message: 'Usunąć ten komentarz?',\r\n      okText: 'Usuń',\r\n      cancelText: 'Anuluj'\r\n    })\r\n    if (!ok) return\r\n\r\n    try {\r\n      const res = await fetch(`${API_BASE}/api/comments/${id}`, {\r\n        method: 'DELETE',\r\n        credentials: 'include'\r\n      })\r\n      if (!res.ok) throw new Error((await res.json())?.message || `Błąd ${res.status}`)\r\n      commentEl.remove()\r\n      toast('Komentarz usunięty.', 'success')\r\n\r\n      if (!container.querySelector('.comment')) {\r\n        container.innerHTML = '<p>Brak komentarzy.</p>'\r\n      }\r\n    } catch (err) {\r\n      toastError(err.message || 'Błąd usuwania komentarza.')\r\n    }\r\n    return\r\n  }\r\n\r\n  // ========== WEJDŹ W TRYB EDYCJI ==========\r\n  if (e.target.closest('.btn-edit-comment')) {\r\n    // jeśli już edytujemy ten komentarz – nic nie rób\r\n    if (commentEl.classList.contains('is-editing') ||\r\n        commentEl.querySelector('.edit-comment-text')) return\r\n\r\n    const textWrap = commentEl.querySelector('.comment-text')\r\n    if (!textWrap) return\r\n\r\n    // zapamiętaj oryginalny HTML (mogą być linki itp.)\r\n    commentEl.dataset.originalHtml = textWrap.innerHTML\r\n\r\n    const oldText = textWrap.textContent\r\n    textWrap.innerHTML = `\r\n      <textarea class=\"edit-comment-text\">${oldText}</textarea>\r\n      <div class=\"edit-actions\">\r\n        <button class=\"btn--sm btn-save-comment\">Zapisz</button>\r\n        <button class=\"btn--sm btn-cancel-edit\">Anuluj</button>\r\n      </div>\r\n    `\r\n    commentEl.classList.add('is-editing')\r\n\r\n    // zablokuj przycisk \"Edytuj\" na czas edycji (opcjonalnie)\r\n    const editBtn = commentEl.querySelector('.btn-edit-comment')\r\n    if (editBtn) editBtn.disabled = true\r\n\r\n    // autofocus\r\n    commentEl.querySelector('.edit-comment-text')?.focus()\r\n    return\r\n  }\r\n\r\n  // ========== ANULUJ EDYCJĘ ==========\r\n  if (e.target.closest('.btn-cancel-edit')) {\r\n    const textWrap = commentEl.querySelector('.comment-text')\r\n    const original = commentEl.dataset.originalHtml || textWrap?.textContent || ''\r\n    if (textWrap) textWrap.innerHTML = original\r\n\r\n    commentEl.classList.remove('is-editing')\r\n    delete commentEl.dataset.originalHtml\r\n\r\n    const editBtn = commentEl.querySelector('.btn-edit-comment')\r\n    if (editBtn) editBtn.disabled = false\r\n    return\r\n  }\r\n\r\n  // ========== ZAPISZ EDYCJĘ ==========\r\n  if (e.target.closest('.btn-save-comment')) {\r\n    const area = commentEl.querySelector('.edit-comment-text')\r\n    const newText = (area?.value || '').trim()\r\n    if (newText.length < 6) {\r\n      toastError('Komentarz musi mieć co najmniej 6 znaków.')\r\n      area?.focus()\r\n      return\r\n    }\r\n\r\n    try {\r\n      const res = await fetch(`${API_BASE}/api/comments/${id}`, {\r\n        method: 'PUT',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        credentials: 'include',\r\n        body: JSON.stringify({ text: newText })\r\n      })\r\n      const data = await res.json().catch(() => ({}))\r\n      if (!res.ok) throw new Error(data?.message || `Błąd ${res.status}`)\r\n\r\n      // backend zwraca zsanityzowany HTML w data.text\r\n      const textWrap = commentEl.querySelector('.comment-text')\r\n      if (textWrap) textWrap.innerHTML = data.text\r\n\r\n      toast('Komentarz zaktualizowany.', 'success')\r\n    } catch (err) {\r\n      toastError(err.message || 'Błąd zapisu komentarza.')\r\n      // w razie błędu możesz zostawić edycję otwartą – to wygodniejsze dla usera\r\n      return\r\n    } finally {\r\n      commentEl.classList.remove('is-editing')\r\n      delete commentEl.dataset.originalHtml\r\n      const editBtn = commentEl.querySelector('.btn-edit-comment')\r\n      if (editBtn) editBtn.disabled = false\r\n    }\r\n  }\r\n})\r\n\r\nfunction fmtDate(iso) {\r\n  if (!iso) return ''\r\n  try {\r\n    const d = new Date(iso)\r\n    return d.toLocaleDateString('pl-PL', { year: 'numeric', month: 'long', day: 'numeric' })\r\n  } catch { return '' }\r\n}\r\n\r\nfunction renderGallery(images = []) {\r\n  galleryEl.innerHTML = ''\r\n  if (!images || images.length === 0) return\r\n\r\n  const safe = images.map(src => `${API_BASE}/${String(src).replace(/^\\/+/, '')}`)\r\n\r\n  const main = document.createElement('div')\r\n  main.className = 'gallery-main'\r\n  main.innerHTML = `<img src=\"${safe[0]}\" alt=\"\">`\r\n\r\n  const thumbs = document.createElement('div')\r\n  thumbs.className = 'thumbs'\r\n  thumbs.innerHTML = safe.map((s, i) =>\r\n    `<img src=\"${s}\" alt=\"\" data-idx=\"${i}\" class=\"${i === 0 ? 'active' : ''}\">`\r\n  ).join('')\r\n\r\n  thumbs.addEventListener('click', (e) => {\r\n    const img = e.target.closest('img[data-idx]')\r\n    if (!img) return\r\n    const idx = Number(img.dataset.idx)\r\n    main.querySelector('img').src = safe[idx]\r\n    thumbs.querySelectorAll('img').forEach(t => t.classList.remove('active'))\r\n    img.classList.add('active')\r\n  })\r\n\r\n  galleryEl.appendChild(main)\r\n  if (safe.length > 1) galleryEl.appendChild(thumbs)\r\n}\r\n\r\nlet likeBusy = false\r\n\r\nasync function handleLikeToggle(e) {\r\n  if (likeBusy) return\r\n  likeBusy = true\r\n  const btn = e.currentTarget\r\n  btn.disabled = true\r\n\r\n  const countEl = document.getElementById('likes-count')\r\n  const prevLiked = likedByMe\r\n  const prevCount = likesCount\r\n\r\n  likedByMe = !likedByMe\r\n  likesCount += likedByMe ? 1 : -1\r\n  if (countEl) countEl.textContent = String(Math.max(0, likesCount))\r\n  btn.querySelector('.like-label').textContent = likedByMe ? 'Lubisz' : 'Lubię to'\r\n  btn.setAttribute('aria-pressed', likedByMe ? 'true' : 'false')\r\n  btn.setAttribute('aria-label', likedByMe ? 'Cofnij polubienie' : 'Polub artykuł')\r\n\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/articles/${articleId}/like`, {\r\n      method: 'POST',\r\n      credentials: 'include'\r\n    })\r\n    const data = await res.json().catch(() => ({}))\r\n    if (!res.ok) throw new Error(data?.message || `Błąd ${res.status}`)\r\n\r\n    if (typeof data.totalLikes === 'number') {\r\n      likesCount = data.totalLikes\r\n      if (countEl) countEl.textContent = String(Math.max(0, likesCount))\r\n    }\r\n    likedByMe = !!data.liked\r\n    btn.querySelector('.like-label').textContent = likedByMe ? 'Lubisz' : 'Lubię to'\r\n    btn.setAttribute('aria-pressed', likedByMe ? 'true' : 'false')\r\n    btn.setAttribute('aria-label', likedByMe ? 'Cofnij polubienie' : 'Polub artykuł')\r\n  } catch (err) {\r\n    likedByMe = prevLiked\r\n    likesCount = prevCount\r\n    if (countEl) countEl.textContent = String(Math.max(0, likesCount))\r\n    btn.querySelector('.like-label').textContent = likedByMe ? 'Lubisz' : 'Lubię to'\r\n    btn.setAttribute('aria-pressed', likedByMe ? 'true' : 'false')\r\n    btn.setAttribute('aria-label', likedByMe ? 'Cofnij polubienie' : 'Polub artykuł')\r\n    toastError(err.message || 'Nie udało się zapisać polubienia.')\r\n  } finally {\r\n    btn.disabled = false\r\n    likeBusy = false\r\n  }\r\n}\r\n\r\nasync function handleDeleteArticle() {\r\n  const ok = await confirmToast({\r\n    message: \"Na pewno usunąć ten artykuł? Tej operacji nie można cofnąć.\",\r\n    okText: \"Usuń\",\r\n    cancelText: \"Anuluj\"\r\n  })\r\n  if (!ok) return\r\n\r\n  const btn = document.getElementById('deleteArticleBtn')\r\n  btn.disabled = true\r\n  try {\r\n    const res = await fetch(`${API_BASE}/api/articles/${articleId}`, {\r\n      method: 'DELETE',\r\n      credentials: 'include'\r\n    })\r\n    if (res.status === 204) {\r\n      toast(\"Artykuł został usunięty.\", \"success\")\r\n      setTimeout(() => {\r\n        const r = document.referrer || ''\r\n        if (r.startsWith(location.origin) && new URL(r).pathname === '/') {\r\n          location.href = r\r\n        } else {\r\n          location.href = '/'\r\n        }\r\n      }, 600)\r\n      return\r\n    }\r\n    const data = await res.json().catch(() => ({}))\r\n    if (res.status === 403) {\r\n      toastError(data?.message || 'Brak uprawnień do usunięcia.')\r\n      document.getElementById('editArticleBtn')?.remove()\r\n      btn?.remove()\r\n      return\r\n    }\r\n    throw new Error(data?.message || `Błąd ${res.status}`)\r\n  } catch (err) {\r\n    toastError(err.message || 'Nie udało się usunąć artykułu.')\r\n  } finally {\r\n    btn.disabled = false\r\n  }\r\n}\r\n\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n  await loadArticle()\r\n  await loadComments()\r\n\r\n  const back = document.getElementById('backToListBtn')\r\n  if (back) {\r\n    try {\r\n      const saved = sessionStorage.getItem('cms:lastListURL')\r\n      if (saved) back.setAttribute('href', saved)\r\n    } catch {}\r\n\r\n    back.addEventListener('click', (e) => {\r\n      try {\r\n        const saved = sessionStorage.getItem('cms:lastListURL')\r\n        if (saved) {\r\n          e.preventDefault()\r\n          location.href = saved\r\n          return\r\n        }\r\n      } catch {}\r\n\r\n      const r = document.referrer || ''\r\n      if (r.startsWith(location.origin)) {\r\n        e.preventDefault()\r\n        history.back()\r\n        return\r\n      }\r\n\r\n      e.preventDefault()\r\n      location.href = '/'\r\n    })\r\n  }\r\n\r\n  try {\r\n    const me = await getProfile()\r\n    const section = document.getElementById(\"comment-form-section\")\r\n    if (section) section.style.display = me ? \"\" : \"none\"\r\n  } catch {\r\n    const section = document.getElementById(\"comment-form-section\")\r\n    if (section) section.style.display = \"none\"\r\n  }\r\n})\r\n"]}